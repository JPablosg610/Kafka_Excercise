import streamlit as st
import pandas as pd
import numpy as np
from sklearn import datasets
from sklearn.model_selection import train_test_split
from sklearn.tree import DecisionTreeClassifier
from sklearn.metrics import accuracy_score, confusion_matrix, ConfusionMatrixDisplay
import matplotlib.pyplot as plt

# =========================
# Login simple
# =========================
USERS = {
    "admin": "1234",
    "user": "abcd"
}

def login(username, password):
    return username in USERS and USERS[username] == password

if "authenticated" not in st.session_state:
    st.session_state["authenticated"] = False

if not st.session_state["authenticated"]:
    st.title("ğŸ” Inicio de sesiÃ³n")
    username = st.text_input("Usuario")
    password = st.text_input("ContraseÃ±a", type="password")
    if st.button("Ingresar"):
        if login(username, password):
            st.session_state["authenticated"] = True
            st.success("Â¡Acceso concedido!")
        else:
            st.error("Usuario o contraseÃ±a incorrectos")
    st.stop()

# =========================
# Barra lateral
# =========================
st.sidebar.title("ğŸ“‚ NavegaciÃ³n")
page = st.sidebar.radio("Ir a", ["AnÃ¡lisis de datos", "Proyecto ML"])

st.sidebar.markdown("---")
st.sidebar.info("Demo interactiva ğŸˆ")

# =========================
# PÃ¡gina: AnÃ¡lisis de datos
# =========================
if page == "AnÃ¡lisis de datos":
    st.title("ğŸ“Š AnÃ¡lisis interactivo de datos")

    data = {
        "Nombre": ["Ana", "Luis", "MarÃ­a", "Juan", "SofÃ­a"],
        "Edad": [25, 30, 22, 28, 35],
        "Departamento": ["Ventas", "IT", "Marketing", "IT", "Ventas"],
        "Salario": [50000, 70000, 48000, 65000, 72000]
    }
    df = pd.DataFrame(data)

    st.subheader("Tabla general")
    st.dataframe(df, use_container_width=True)

    st.subheader("ğŸ¯ Filtrar por departamento")
    dept_options = df["Departamento"].unique()
    selected_dept = st.selectbox("Selecciona departamento", dept_options)
    filtered_df = df[df["Departamento"] == selected_dept]
    st.dataframe(filtered_df, use_container_width=True)

    st.subheader("ğŸ’° GrÃ¡fico de salarios")
    st.bar_chart(filtered_df.set_index("Nombre")["Salario"])

    st.subheader("ğŸ“ˆ EstadÃ­sticas descriptivas")
    st.write(filtered_df.describe())

    csv = filtered_df.to_csv(index=False).encode("utf-8")
    st.download_button("Descargar CSV", csv, "datos_filtrados.csv", "text/csv")

# =========================
# PÃ¡gina: Proyecto ML
# =========================
else:
    st.title("ğŸ¤– Proyecto bÃ¡sico de ML: ClasificaciÃ³n Iris")

    st.markdown(
        """
        En esta demo entrenamos un **Ã¡rbol de decisiÃ³n** usando el clÃ¡sico dataset *Iris* ğŸŒº.
        """
    )

    # Cargar dataset
    iris = datasets.load_iris()
    X = iris.data
    y = iris.target
    feature_names = iris.feature_names
    target_names = iris.target_names

    # Mostrar dataframe
    df_iris = pd.DataFrame(X, columns=feature_names)
    df_iris["target"] = [target_names[i] for i in y]

    with st.expander("ğŸ” Ver datos completos"):
        st.dataframe(df_iris, use_container_width=True)

    # ParÃ¡metros de modelo
    st.sidebar.subheader("âš™ï¸ ParÃ¡metros del modelo")
    max_depth = st.sidebar.slider("MÃ¡xima profundidad del Ã¡rbol", 1, 10, 3)
    test_size = st.sidebar.slider("ProporciÃ³n de test", 0.1, 0.5, 0.3)

    # Dividir datos
    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=test_size, random_state=42
    )

    # Entrenar modelo
    clf = DecisionTreeClassifier(max_depth=max_depth, random_state=42)
    clf.fit(X_train, y_train)

    # Predicciones
    y_pred = clf.predict(X_test)

    # MÃ©tricas
    acc = accuracy_score(y_test, y_pred)
    cm = confusion_matrix(y_test, y_pred)

    st.subheader("âœ… PrecisiÃ³n del modelo")
    st.metric(label="Accuracy", value=f"{acc:.2%}")

    # Mostrar matriz de confusiÃ³n
    st.subheader("ğŸ—ºï¸ Matriz de confusiÃ³n")
    fig, ax = plt.subplots()
    disp = ConfusionMatrixDisplay(confusion_matrix=cm, display_labels=target_names)
    disp.plot(ax=ax, cmap='Blues', colorbar=False)
    st.pyplot(fig)

    st.success("Â¡Modelo entrenado y visualizado correctamente! ğŸš€")



